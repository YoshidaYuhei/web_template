name: Test

on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main

jobs:
  test:
    runs-on: ubuntu-latest

    services:
      postgres:
        image: postgres:16
        env:
          POSTGRES_USER: ${{ vars.DB_USER }}
          POSTGRES_PASSWORD: ${{ secrets.DB_PASSWORD }}
          POSTGRES_DB: ${{ vars.DB_NAME }}_test
        ports:
          - 5432:5432
        options: >-
          --health-cmd "pg_isready -U ${{ vars.DB_USER }} -d ${{ vars.DB_NAME }}_test"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

    env:
      APP_ENV: test
      DB_HOST: localhost
      DB_PORT: 5432
      DB_USER: ${{ vars.DB_USER }}
      DB_PASSWORD: ${{ secrets.DB_PASSWORD }}
      DB_NAME: ${{ vars.DB_NAME }}_test

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install uv
        uses: astral-sh/setup-uv@v4

      - name: Install dependencies
        run: uv sync --all-extras

      - name: Run linter
        run: uv run ruff check .

      - name: Run formatter check
        run: uv run ruff format --check .

      - name: Run tests
        run: uv run pytest -v --cov=app --cov-report=term-missing

  # e2e:
  #   runs-on: ubuntu-latest
  #
  #   env:
  #     FRONTEND_PORT: "2100"
  #     BACKEND_PORT: "8000"
  #     DB_USER: test_user
  #     DB_PASSWORD: test_password
  #     DB_NAME: test_db
  #     SECRET_KEY: test-secret-key
  #     REDIS_PORT: "6379"
  #     DB_PORT: "5432"
  #
  #   steps:
  #     - name: Checkout
  #       uses: actions/checkout@v4
  #
  #     - name: Start services
  #       run: docker compose up -d --wait
  #
  #     - name: Setup Node.js
  #       uses: actions/setup-node@v4
  #       with:
  #         node-version: "20"
  #         cache: npm
  #         cache-dependency-path: frontend/package-lock.json
  #
  #     - name: Install dependencies
  #       working-directory: ./frontend
  #       run: npm ci
  #
  #     - name: Install Playwright Chromium
  #       working-directory: ./frontend
  #       run: npx playwright install --with-deps chromium
  #
  #     - name: Run E2E tests
  #       working-directory: ./frontend
  #       run: npx playwright test
  #
  #     - name: Upload report
  #       if: ${{ !cancelled() }}
  #       uses: actions/upload-artifact@v4
  #       with:
  #         name: playwright-report
  #         path: frontend/playwright-report/
  #         retention-days: 14
  #
  #     - name: Stop services
  #       if: always()
  #       run: docker compose down -v

# name: Deploy to Staging

# on:
#   push:
#     branches:
#       - main

# env:
#   AWS_REGION: ap-northeast-1
#   ECR_REPOSITORY: web-template-stg-app
#   ECS_CLUSTER: web-template-stg-cluster
#   ECS_SERVICE: web-template-stg-app-service
#   S3_BUCKET: web-template-stg-frontend
#   CLOUDFRONT_DISTRIBUTION_ID: ${{ secrets.STG_CLOUDFRONT_DISTRIBUTION_ID }}

# jobs:
#   test:
#     runs-on: ubuntu-latest

#     services:
#       postgres:
#         image: postgres:16
#         env:
#           POSTGRES_USER: test_user
#           POSTGRES_PASSWORD: test_password
#           POSTGRES_DB: test_db
#         ports:
#           - 5432:5432
#         options: >-
#           --health-cmd "pg_isready -U test_user -d test_db"
#           --health-interval 10s
#           --health-timeout 5s
#           --health-retries 5

#     env:
#       DB_HOST: localhost
#       DB_PORT: 5432
#       DB_USER: test_user
#       DB_PASSWORD: test_password
#       DB_NAME: test_db
#       SECRET_KEY: test-secret-key

#     steps:
#       - name: Checkout
#         uses: actions/checkout@v4

#       - name: Setup Python
#         uses: actions/setup-python@v5
#         with:
#           python-version: "3.11"

#       - name: Install uv
#         uses: astral-sh/setup-uv@v4

#       - name: Install dependencies
#         run: uv sync --all-extras

#       - name: Run tests
#         run: uv run pytest -v

#   deploy-backend:
#     needs: test
#     runs-on: ubuntu-latest

#     steps:
#       - name: Checkout
#         uses: actions/checkout@v4

#       - name: Configure AWS credentials
#         uses: aws-actions/configure-aws-credentials@v4
#         with:
#           aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
#           aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
#           aws-region: ${{ env.AWS_REGION }}

#       - name: Login to Amazon ECR
#         id: login-ecr
#         uses: aws-actions/amazon-ecr-login@v2

#       - name: Build, tag, and push image to Amazon ECR
#         id: build-image
#         env:
#           ECR_REGISTRY: ${{ steps.login-ecr.outputs.registry }}
#           IMAGE_TAG: ${{ github.sha }}
#         run: |
#           docker build -t $ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG .
#           docker push $ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG
#           docker tag $ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG $ECR_REGISTRY/$ECR_REPOSITORY:latest
#           docker push $ECR_REGISTRY/$ECR_REPOSITORY:latest
#           echo "image=$ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG" >> $GITHUB_OUTPUT

#       - name: Update ECS service
#         run: |
#           aws ecs update-service \
#             --cluster $ECS_CLUSTER \
#             --service $ECS_SERVICE \
#             --force-new-deployment

#       - name: Wait for service stability
#         run: |
#           aws ecs wait services-stable \
#             --cluster $ECS_CLUSTER \
#             --services $ECS_SERVICE

#   deploy-frontend:
#     needs: test
#     runs-on: ubuntu-latest

#     steps:
#       - name: Checkout
#         uses: actions/checkout@v4

#       - name: Setup Node.js
#         uses: actions/setup-node@v4
#         with:
#           node-version: "20"

#       - name: Install dependencies
#         working-directory: ./frontend
#         run: npm ci

#       - name: Build
#         working-directory: ./frontend
#         env:
#           VITE_API_URL: ""  # CloudFront経由なので空
#         run: npm run build

#       - name: Configure AWS credentials
#         uses: aws-actions/configure-aws-credentials@v4
#         with:
#           aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
#           aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
#           aws-region: ${{ env.AWS_REGION }}

#       - name: Deploy to S3
#         working-directory: ./frontend
#         run: |
#           aws s3 sync dist/ s3://$S3_BUCKET --delete

#       - name: Invalidate CloudFront cache
#         run: |
#           aws cloudfront create-invalidation \
#             --distribution-id $CLOUDFRONT_DISTRIBUTION_ID \
#             --paths "/*"
